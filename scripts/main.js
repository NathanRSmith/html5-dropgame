function getMousePos(a,b){var c=a.getBoundingClientRect();return{x:b.clientX-c.left,y:b.clientY-c.top}}function boolToInt(a){return a?1:0}var CellModel=Backbone.Model.extend({defaults:{visited:!1},getColorString:function(a){return a[this.get("color")]},matches:function(a){try{return this.get("color")==a.get("color")}catch(b){return!1}},isVisited:function(){return this.get("visited")},updateCellAddr:function(a,b){this.set("row",a),this.set("col",b)}}),DropGameMatrix=Backbone.Collection.extend({modelClass:CellModel,initialize:function(a){this.height=a.height,this.width=a.width,this.numColors=a.numColors,this.generateRandomMatrix()},at:function(a,b){try{return this._matrix[a][b]}catch(c){return void 0}},getHeight:function(){return this.height},getWidth:function(){return this.width},setAddr:function(a,b,c){this._matrix[a][b]=c},generateRandomMatrix:function(){for(var a=new Array(this.height),b=0;b<this.height;b++){a[b]=new Array(this.width);for(var c=0;c<this.width;c++)a[b][c]=this._generateRandomCell(b,c)}this._matrix=a},generateMatrix:function(a){for(var b=new Array(this.height),c=0;c<this.height;c++){b[c]=new Array(this.width);for(var d=0;d<this.width;d++)b[c][d]=new this.modelClass({row:c,col:d,color:a[c][d]})}this._matrix=b},_generateRandomCell:function(a,b){return new this.modelClass({color:_.random(0,this.numColors-1),row:a,col:b})},selectCell:function(a,b){var c=this._removeGroup(this.at(a,b));return console.log(c),this._applyGravity(),this._resetAllVisited(),c},_removeGroup:function(a){var b=this,c=0;return this._resetAllVisited(),1==this._visitGroup(a)&&this.each(function(a){a&&a.isVisited()&&(b.removeCell(a),c++)}),c},countCells:function(){var a=0;return this.each(function(b){b&&a++}),a},countGroups:function(){var a=this;this._resetAllVisited();var b=0;return this.each(function(c){1==a._visitGroup(c)&&b++}),this._resetAllVisited(),b},_visitGroup:function(a){if(a&&!a.isVisited()){var b=a.get("row"),c=a.get("col");a.set("visited",!0);var d=this._cellHasAdjacent(a);if(1==d){var e;e=this.at(b,c-1),e&&!e.isVisited()&&a.matches(e)&&this._visitGroup(e),e=this.at(b-1,c),e&&!e.isVisited()&&a.matches(e)&&this._visitGroup(e),e=this.at(b,c+1),e&&!e.isVisited()&&a.matches(e)&&this._visitGroup(e),e=this.at(b+1,c),e&&!e.isVisited()&&a.matches(e)&&this._visitGroup(e)}return d}},_resetAllVisited:function(){this.each(function(a){a&&a.set("visited",!1)})},each:function(a){for(var b=0;b<this.getHeight();b++)for(var c=0;c<this.getWidth();c++)a(this.at(b,c),[b,c],this.collection)},removeCell:function(a){this._matrix[a.get("row")][a.get("col")]=null},_cellHasAdjacent:function(a){if(a){var b=a.get("row"),c=a.get("col");if(a.matches(this.at(b,c-1)))return!0;if(a.matches(this.at(b-1,c)))return!0;if(a.matches(this.at(b,c+1)))return!0;if(a.matches(this.at(b+1,c)))return!0}return!1},_hasAdjacent:function(a,b){return this._cellHasAdjacent(this.at(a,b))},_applyGravity:function(){this._applyDownGravity(),this._applyRightColumnGravity()},_applyRightColumnGravity:function(){for(var a=this.getWidth()-1;a>=1;a--)if(this._isColumnEmpty(a)){for(var b=-1,c=a-1;c>=0;c--)if(!this._isColumnEmpty(c)){b=c;break}for(var c=b;c>=0;c--)for(var d=0;d<this.getHeight();d++)this.at(d,c)&&(this.setAddr(d,a-b+c,this.at(d,c)),this.at(d,a-b+c).updateCellAddr(d,a-b+c),this.setAddr(d,c,null))}},_isColumnEmpty:function(a){for(var b=!0,c=0;c<this.getHeight();c++)if(null!=this.at(c,a)){b=!1;break}return b},_applyDownGravity:function(){for(var a=this.getHeight()-1;a>=0;a--)for(var b=0;b<this.getWidth();b++)if(null==this.at(a,b)){for(var c=-1,d=a-1;d>=0;d--)if(null!=this.at(d,b)){c=d;break}for(var d=c;d>=0;d--)this.at(d,b)&&(this.setAddr(a-c+d,b,this.at(d,b)),this.at(a-c+d,b).updateCellAddr(a-c+d,b),this.setAddr(d,b,null))}},printMatrix:function(){for(var a=0;a<this.getHeight();a++){for(var b=[],c=0;c<this.getWidth();c++)b.push(this.at(a,c)?this.at(a,c).get("color"):"n");console.log(b.join(", "))}},printVisited:function(){for(var a=0;a<this.getHeight();a++){for(var b=[],c=0;c<this.getWidth();c++)b.push(this.at(a,c)?boolToInt(this.at(a,c).get("visited")):"n");console.log(b.join(", "))}}});dispatcher=_.extend({},Backbone.Events);var ShowHeltBtnView=Backbone.View.extend({el:".show-help",events:{click:"clickHandler"},clickHandler:function(){helpView.show()}}),HelpView=Backbone.View.extend({el:"#game_help",events:{"click .close-help":"hide"},show:function(){return this.$el.show(),this},hide:function(){return this.$el.hide(),this}}),ShowStatisticsBtnView=Backbone.View.extend({el:".show-statistics",events:{click:"clickHandler"},clickHandler:function(){statisticsView.render().show()}}),StatisticsView=Backbone.View.extend({el:"#game_statistics",events:{"click .reset-statistics":"reset","click .close-statistics":"hide"},initialize:function(){this.listenTo(dispatcher,"postGameOver",this.gameOverHandler)},render:function(){return this.options.localstorage?(this.$(".high-score").html(localStorage.highScore||""),this.$(".low-score").html(localStorage.lowScore||""),this.$(".average-score").html(parseFloat(localStorage.averageScore).toFixed(1)||""),this.$(".games-played").html(localStorage.gamesPlayed||"0"),this.$(".average-number-moves").html(parseFloat(localStorage.averageNumberMoves).toFixed(1)||""),this.$(".average-blocks-left").html(parseFloat(localStorage.averageBlocksLeft).toFixed(1)||""),this.$(".no-localstorage").hide(),this.$(".localstorage").show(),this.$(".reset-statistics").show()):(this.$(".no-localstorage").show(),this.$(".localstorage").hide(),this.$(".reset-statistics").hide()),this},gameOverHandler:function(){localStorage.gamesPlayed=this.lstor("gamesPlayed",0,"i")+1,localStorage.highScore=Math.max(this.lstor("highScore",-9999,"i"),summaryView.totalScore),localStorage.lowScore=Math.min(this.lstor("lowScore",9999,"i"),summaryView.totalScore);var a=this.lstor("averageScore",0,"f");localStorage.averageScore=(a*(localStorage.gamesPlayed-1)+summaryView.totalScore)/localStorage.gamesPlayed;var a=this.lstor("averageNumberMoves",0,"f");localStorage.averageNumberMoves=(a*(localStorage.gamesPlayed-1)+summaryView.totalMoves)/localStorage.gamesPlayed;var a=this.lstor("averageBlocksLeft",0,"f");localStorage.averageBlocksLeft=(a*(localStorage.gamesPlayed-1)+summaryView.blocksLeft)/localStorage.gamesPlayed},lstor:function(a,b,c){var d=null!=localStorage[a]?localStorage[a]:b;if(c){if("f"==c)return parseFloat(d);if("i"==c)return parseInt(d)}return d},newGameHandler:function(){this.hide()},reset:function(){return localStorage.removeItem("highScore"),localStorage.removeItem("lowScore"),localStorage.removeItem("averageScore"),localStorage.removeItem("gamesPlayed"),localStorage.removeItem("averageGameTime"),localStorage.removeItem("averageNumberMoves"),localStorage.removeItem("averageBlocksLeft"),this.render(),this},show:function(){return this.$el.show(),this},hide:function(){return this.$el.hide(),this}}),SummaryView=Backbone.View.extend({el:"#game_summary",time:null,totalMoves:null,blocksLeft:null,score:null,scorePenalty:null,totalScore:null,initialize:function(){this.listenTo(dispatcher,"postGameOver",this.gameOverHandler),this.listenTo(dispatcher,"newGame",this.newGameHandler)},gameOverHandler:function(){this.$(".game-time").html(this.fetchTime()),this.$(".total-moves").html(this.fetchMoves()),this.$(".blocks-left").html(this.fetchBlocksLeft()),this.$(".score").html(this.fetchScore()),this.$(".score-penalty").html(this.fetchScorePenalty()),this.$(".total-score").html(this.fetchTotalScore()),this.show()},fetchTime:function(){return this.time=gameTimeView.getTime(),gameTimeView.getTimeString()},fetchMoves:function(){return this.totalMoves=game.totalMoves,this.totalMoves},fetchBlocksLeft:function(){return this.blocksLeft=game.collection.countCells(),this.blocksLeft},fetchScore:function(){return this.score=scoreView.getScore(),this.score},fetchScorePenalty:function(){return this.scorePenalty=scoreView.calculateScorePenalty(this.blocksLeft),this.scorePenalty},fetchTotalScore:function(){return this.totalScore=this.score-this.scorePenalty,this.totalScore},newGameHandler:function(){this.hide()},show:function(){return this.$el.show(),this},hide:function(){return this.$el.hide(),this}}),GameTimeView=Backbone.View.extend({el:"#game_time",timer:null,refresh:1e3,time:0,starttime:null,initialize:function(){this.listenTo(dispatcher,"preGameOver",this.stopTimer),this.listenTo(dispatcher,"newGame",this.startTimer),this.startTimer()},render:function(){this.$el.html(this.getTimeString())},getTime:function(){return this.time},getTimeString:function(a){a=a||this.time;var b=parseInt(a/60),c=parseInt(a%60);return this._getIntTimeString(b)+":"+this._getIntTimeString(c)},_getIntTimeString:function(a){var b=a.toString();return 1==b.length?"0"+b:b},startTimer:function(){var a=this;this.starttime=Date.now(),this.time=0,this.timer=setInterval(function(){a.timeEventHandler()},this.refresh),this.render()},timeEventHandler:function(){this.time=parseInt((Date.now()-this.starttime)/1e3),this.render()},stopTimer:function(){this.time=parseInt((Date.now()-this.starttime)/1e3),clearInterval(this.timer),this.render()}}),ScoreView=Backbone.View.extend({el:"#score",score:0,scorePenalty:0,initialize:function(){this.listenTo(dispatcher,"moveMade",this.moveHandler),this.listenTo(dispatcher,"newGame",this.resetScore),this.render()},render:function(){this.$el.html("Score: "+this.score)},moveHandler:function(a){var b=this.computeMoveScore(a.get("removed"));this.updateScore(b),this.render()},computeMoveScore:function(a){return a*(a-1)},updateScore:function(a){this.score+=a,this.render()},resetScore:function(){this.score=0,this.render()},getScore:function(){return this.score},calculateScorePenalty:function(a){return this.scorePenalty=10*a,this.scorePenalty}}),NewGameBtnView=Backbone.View.extend({el:"#new_game",events:{click:"btnClicked"},btnClicked:function(){dispatcher.trigger("preNewGame")}}),MovesLeftView=Backbone.View.extend({el:"#moves_left",initialize:function(){this.listenTo(dispatcher,"moveMade",this.moveCallback),this.listenTo(dispatcher,"newGame",this.newGameCallback),this.render(game.collection.countGroups())},newGameCallback:function(){this.render(game.collection.countGroups())},moveCallback:function(a){this.render(a.get("moves"))},render:function(a){this.$el.html(a+" moves left")}}),BlocksLeftView=Backbone.View.extend({el:"#blocks_left",initialize:function(){this.listenTo(dispatcher,"moveMade",this.countAndRender),this.listenTo(dispatcher,"newGame",this.countAndRender),this.countAndRender()},countAndRender:function(){this.render(game.collection.countCells())},render:function(a){this.$el.html(a+" blocks left")}}),DropGameCanvasView=Backbone.View.extend({_backgroundColor:"#000",_gameMatrixClass:DropGameMatrix,_rows:10,_cols:10,_NUM_COLORS:5,_COLOR_MAP:["blue","red","green","orange","purple"],_CELL_HEIGHT:25,_CELL_WIDTH:25,_CELL_PADDING:2,_CANVAS_PADDING:0,DEBUG_MATRIX:[[0,0,1],[2,1,1],[1,0,0]],gameOver:!1,totalMoves:0,events:{click:"_clickHandler"},initialize:function(a){this.subclassPreInitialize(a),this._rows=a.rows||this._rows,this._cols=a.cols||this._cols,this._NUM_COLORS=a.numColors||this._NUM_COLORS,this.collection=new this._gameMatrixClass({height:this._rows,width:this._cols,numColors:this._NUM_COLORS}),this.listenTo(dispatcher,"preNewGame",this.newGameHandler),this._initializeCanvas(),this.draw(),this.subclassPostInitialize(a)},subclassPreInitialize:function(){},subclassPostInitialize:function(){},_clickHandler:function(a){if(0==this.gameOver){var b=getMousePos(this.el,a),c=this.getCellAddressFromXY(b.x,b.y);if(console.log(b,c),c){var d=this.collection.selectCell(c.row,c.col);this.draw();var e=this.collection.countGroups();this.totalMoves++,dispatcher.trigger("moveMade",new Backbone.Model({x:b.x,y:b.y,row:c.row,col:c.col,removed:d,moves:e})),0==e&&(this.gameOver=!0,dispatcher.trigger("preGameOver"),dispatcher.trigger("gameOver"),dispatcher.trigger("postGameOver"))}}},newGameHandler:function(){this.totalMoves=0,this.gameOver=!1,this.collection.generateRandomMatrix(),this._initializeCanvas(),this.draw(),dispatcher.trigger("newGame")},getCellAddressFromXY:function(a,b){return{col:Math.floor(a/this._calculateCellWidth()),row:Math.floor(b/this._calculateCellHeight())}},draw:function(){this._drawBackground(),this._drawGameMatrix()},_initializeCanvas:function(){var a=this._calculateCanvasSize();this.$el.attr("height",a[0]),this.$el.attr("width",a[1])},_calculateCanvasSize:function(){var a=this._rows*this._calculateCellHeight(),b=this._cols*this._calculateCellWidth();return[a,b]},_calculateCellHeight:function(){return this._CELL_HEIGHT+2*this._CELL_PADDING},_calculateCellWidth:function(){return this._CELL_WIDTH+2*this._CELL_PADDING},_drawBackground:function(){this.$el.drawRect({fillStyle:this._backgroundColor,x:0,y:0,width:this.$el.width(),height:this.$el.height(),fromCenter:!1})},_drawGameMatrix:function(){for(var a=0;a<this._rows;a++)for(var b=0;b<this._rows;b++){var c=a*this._calculateCellHeight(),d=b*this._calculateCellWidth();this._drawCell(c,d,this.collection.at(a,b))}},_drawCell:function(a,b,c){c&&this.$el.drawRect({fillStyle:c.getColorString(this._COLOR_MAP),x:b+this._CELL_PADDING,y:a+this._CELL_PADDING,width:this._CELL_WIDTH,height:this._CELL_HEIGHT,fromCenter:!1})},printColors:function(){console.log(this._COLOR_MAP.join(", "))}}),DropGameFullCanvasView=DropGameCanvasView.extend({el:"#dropgame_canvas",subclassPostInitialize:function(){var a=this;$(window).resize(function(b){a.resizeHandler(b)})},resizeTimeout:null,resizeHandler:function(){var a=this;clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(function(){a._initializeCanvas(),a.draw()},100)},_initializeCanvas:function(){this.$el[0].height=this.$el.parent().height(),this.$el[0].width=this.$el.parent().width();var a=this.$el.height(),b=this.$el.width(),c=this._calculateInitialCellHeight(a),d=this._calculateInitialCellWidth(b),e=Math.min(c,d);this._CELL_HEIGHT=e,this._CELL_WIDTH=e;var f=this._calculateCanvasSize(),g=(Math.round((a-f[0])/2),Math.round((b-f[1])/2));this.BBOX={miny:a-f[0],maxy:this.$el.height(),minx:g,maxx:this.$el.width()-g}},_calculateInitialCellHeight:function(a){return Math.floor(a/this._rows-2*this._CELL_PADDING)},_calculateInitialCellWidth:function(a){return Math.floor(a/this._cols-2*this._CELL_PADDING)},_drawGameMatrix:function(){for(var a=0;a<this._rows;a++)for(var b=0;b<this._rows;b++){var c=a*this._calculateCellHeight()+this.BBOX.miny,d=b*this._calculateCellWidth()+this.BBOX.minx;this._drawCell(c,d,this.collection.at(a,b))}},getCellAddressFromXY:function(a,b){return this._withinBBOX(a,b)?{col:Math.floor((a-this.BBOX.minx)/this._calculateCellWidth()),row:Math.floor((b-this.BBOX.miny)/this._calculateCellHeight())}:null},_withinBBOX:function(a,b){return a>this.BBOX.minx&&a<this.BBOX.maxx&&b>this.BBOX.miny&&b<this.BBOX.maxy?!0:!1}});Modernizr.canvas||alert("HTML5 Canvas elements are not supported in your browser and you will not be able to play this game.\nPlease try another browser such as Chrome or Firefox."),$(document).ready(function(){game=new DropGameFullCanvasView({el:"#dropgame_canvas"}),movesLeftView=new MovesLeftView,newGameBtnView=new NewGameBtnView({el:".new-game"}),scoreView=new ScoreView,blocksLeftView=new BlocksLeftView,gameTimeView=new GameTimeView,summaryView=new SummaryView,statisticsView=new StatisticsView({localstorage:Modernizr.localstorage}),showStatisticsBtnView=new ShowStatisticsBtnView({el:".show-statistics"}),helpView=new HelpView,showHelpBtnView=new ShowHeltBtnView});